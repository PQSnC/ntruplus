#include "params.h"
#include "reduce.h"
#include "ntt.h"

int16_t zetas[127] = {886, 1520, 1571, 704, 624, 813, 1742, 594, 2255, 2260, 2946, 137, 200, 2500, 16, 2682, 963, 3395, 1045, 2987, 2569, 2728, 2418, 1548, 115, 3166, 1392, 1028, 1854, 2433, 978, 2585, 1427, 2281, 529, 341, 2895, 3346, 923, 975, 2357, 78, 3369, 2041, 2, 25, 415, 631, 795, 1295, 755, 3349, 3047, 1789, 1350, 2692, 1129, 2013, 920, 2547, 2179, 1310, 1004, 1987, 3254, 2648, 1090, 2454, 2018, 1026, 438, 1826, 3347, 2082, 1374, 2624, 1383, 1731, 1770, 2825, 1954, 226, 986, 152, 449, 427, 1557, 2229, 1740, 1008, 1522, 2177, 2951, 589, 2172, 2621, 2716, 2837, 79, 2214, 1491, 3081, 3438, 126, 2783, 1946, 1882, 1370, 2000, 801, 160, 2853, 1036, 2579, 636, 2377, 2814, 605, 3129, 2721, 919, 2845, 2286, 1271, 1048, 2729, 3126};

int16_t zetas_inv[127] = {331, 728, 2409, 2186, 1171, 612, 2538, 736, 328, 2852, 643, 1080, 2821, 878, 2421, 604, 3297, 2656, 1457, 2087, 1575, 1511, 674, 3331, 19, 376, 1966, 1243, 3378, 620, 741, 836, 1285, 2868, 506, 1280, 1935, 2449, 1717, 1228, 1900, 3030, 3008, 3305, 2471, 3231, 1503, 632, 1687, 1726, 2074, 833, 2083, 1375, 110, 1631, 3019, 2431, 1439, 1003, 2367, 809, 203, 1470, 2453, 2147, 1278, 910, 2537, 1444, 2328, 765, 2107, 1668, 410, 108, 2702, 2162, 2662, 2826, 3042, 3432, 3455, 1416, 88, 3379, 1100, 2482, 2534, 111, 562, 3116, 2928, 1176, 2030, 872, 2479, 1024, 1603, 2429, 2065, 291, 3342, 1909, 1039, 729, 888, 470, 2412, 62, 2494, 775, 3441, 957, 3257, 3320, 511, 1197, 1202, 2863, 1715, 2644, 2833, 2753, 1886, 1937, 1665};

void ntt(int16_t a[1024])
{
	int16_t t;
	int16_t zeta;
	int k = 0;

	zeta = zetas[k++];

	for(int i = 0; i < 512; i++)
	{
		t = fqmul(zeta, a[i + 512]);

		a[i + 512] = (a[i] + a[i + 512] - t);
		a[i      ] = (a[i] + t);
	}

	for(int step = 256; step >= 8; step >>= 1)
	{
		for(int start = 0; start < 1024; start += (step << 1))
		{
			zeta = zetas[k++];

			for(int i = start; i < start + step; i++)
			{
				t = fqmul(zeta, a[i + step]);
				
				a[i + step] = fqred16(a[i] - t);
				a[i       ] = fqred16(a[i] + t);
			}
		}
	}
}

void invntt(int16_t a[1024])
{
	int16_t t1, t2;
	int16_t zeta;

	int k = 0;

	for(int step = 8; step <= 256; step <<= 1)
	{
		for(int start = 0; start < 1024; start += (step << 1))
		{
			zeta = zetas_inv[k++];

			for(int i = start; i < start + step; i++)
			{
				t1 = a[i + step];

				a[i + step] = fqred16(fqmul(zeta, a[i] - t1));
				a[i       ] = fqred16(a[i] + t1);
			}
		}
	}

	zeta = zetas_inv[k];//(\psi-\psi^5)^-1

	for(int i = 0; i < 512; i++)
	{
		t1 = fqred16(a[i] + a[i + 512]);
		t2 = fqmul(zeta, a[i] - a[i + 512]);

		a[i      ] = fqred16(fqmul((1 << 9) % 3457, t1 - t2));
		a[i + 512] = fqred16(fqmul((1 << 10) % 3457, t2));	
	}
}

/*
(a[0] + a[1]x)(b[0] + b[1]x)

(a[0] + a[1])(b[0] + b[1]) - a[0]b[0] - a[1]b[1]

(a[0]b[0] + a[1]b[1]*zeta) + (a[1]b[0] + a[0]b[1])x
(a[0]b[0] + a[1]b[1]*zeta) + ((a[0] + a[1])(b[0] + b[1]) - a[0]b[0] - a[1]b[1])x

*/
//M^-1
void basemul(int16_t c[8], const int16_t a[8], const int16_t b[8], int16_t zeta)
{

	int16_t t[15] = {0};

	for (int i = 0; i < 8; i++)
	{
		for (int j = 0; j < 8; i++)
		{
			t[i + j] += fqmul(a[i], b[j]); 
		}
	}

	for (int i = 0; i < 8; i++)
	{
		c[i] = t[i];
	}

	for (int i = 0; i < 7; i++)
	{
		c[i] += fqmul(c[i + 8], zeta);
	}
}

int baseinv(int16_t b[2], const int16_t a[2], int16_t zeta)
{
	int16_t det, t;
	int r;

	det = fqmul(a[0], a[0]); //M^-1
	t = fqmul(a[1], a[1]); //M^-1
	t = fqmul(t, zeta); //M^-1
	det = det - t; //M^-1

	det   = fqinv(det); //M^3
	b[0] = fqmul(a[0], det); //M^2
	b[1] = fqmul(NTRUPLUS_Q - a[1], det); //M^2

	r = (uint16_t)det;
	r = (uint32_t)(-r) >> 31;
	return r - 1;
}